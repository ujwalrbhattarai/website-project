{% extends "base.html" %}

{% block title %}
{% if session.role == 'admin' %}Admin{% elif session.role == 'management' %}Management{% elif session.role == 'faculty' %}Faculty{% else %}Student{% endif %} Dashboard - The Innovative Group
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                {% if session.role == 'admin' %}
                <i class="fas fa-user-shield"></i> Admin Dashboard
                {% elif session.role == 'management' %}
                <i class="fas fa-chart-line"></i> Management Dashboard
                {% elif session.role == 'faculty' %}
                <i class="fas fa-chalkboard-teacher"></i> Faculty Dashboard
                {% else %}
                <i class="fas fa-graduation-cap"></i> Student Dashboard
                {% endif %}
            </h2>
            <p class="text-muted">Welcome back, {{ user.full_name }}</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        {% if session.role == 'admin' %}
        <!-- Admin Stats -->
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                    <h3>{{ total_users }}</h3>
                    <p class="text-muted mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-book fa-3x text-success mb-3"></i>
                    <h3>{{ total_courses }}</h3>
                    <p class="text-muted mb-0">Total Courses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-user-graduate fa-3x text-info mb-3"></i>
                    <h3>{{ total_students }}</h3>
                    <p class="text-muted mb-0">Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-money-bill-wave fa-3x text-warning mb-3"></i>
                    <h3>NPR {{ "{:,.0f}".format(total_revenue) }}</h3>
                    <p class="text-muted mb-0">Total Revenue</p>
                </div>
            </div>
        </div>

        {% elif session.role == 'management' %}
        <!-- Management Stats -->
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                    <h3>{{ total_students }}</h3>
                    <p class="text-muted mb-0">Total Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-chalkboard-teacher fa-3x text-info mb-3"></i>
                    <h3>{{ total_faculty }}</h3>
                    <p class="text-muted mb-0">Faculty Members</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-book fa-3x text-success mb-3"></i>
                    <h3>{{ total_courses }}</h3>
                    <p class="text-muted mb-0">Active Courses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-ticket-alt fa-3x text-warning mb-3"></i>
                    <h3>{{ total_tickets }}</h3>
                    <p class="text-muted mb-0">Support Tickets</p>
                </div>
            </div>
        </div>

        {% elif session.role == 'faculty' %}
        <!-- Faculty Stats -->
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-book fa-3x text-primary mb-3"></i>
                    <h3>{{ my_courses|length if my_courses else 0 }}</h3>
                    <p class="text-muted mb-0">My Courses</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-3x text-success mb-3"></i>
                    <h3>{{ total_students }}</h3>
                    <p class="text-muted mb-0">Total Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-video fa-3x text-info mb-3"></i>
                    <h3>{{ total_videos }}</h3>
                    <p class="text-muted mb-0">Total Videos</p>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Student Stats -->
        <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                <h3>{{ enrollments|length if enrollments else 0 }}</h3>
                <p><i class="fas fa-book"></i> Enrolled Courses</p>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                <h3>{{ total_payments }}</h3>
                <p><i class="fas fa-receipt"></i> Total Payments</p>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                <h3>{{ user.study_history|list|length }}</h3>
                <p><i class="fas fa-play-circle"></i> Videos Watched</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Content Section -->
    <div class="row">
        {% if session.role == 'admin' %}
        <!-- Admin: Recent Users and Quick Actions -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Recent Users</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_users %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in recent_users %}
                                <tr>
                                    <td>{{ u.full_name }}</td>
                                    <td>{{ u.email }}</td>
                                    <td><span class="badge bg-{{ 'danger' if u.role == 'admin' else 'primary' if u.role == 'faculty' else 'info' if u.role == 'management' else 'success' }}">{{ u.role|title }}</span></td>
                                    <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No recent users</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('admin.users') }}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                    <a href="{{ url_for('admin.courses') }}" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-book"></i> Manage Courses
                    </a>
                    <a href="{{ url_for('admin.reports') }}" class="btn btn-info w-100 mb-2">
                        <i class="fas fa-chart-bar"></i> View Reports
                    </a>
                    <a href="{{ url_for('admin.support') }}" class="btn btn-warning w-100">
                        <i class="fas fa-ticket-alt"></i> Support Tickets
                    </a>
                </div>
            </div>
        </div>

        {% elif session.role == 'management' %}
        <!-- Management: Tickets and Enrollments -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> Recent Support Tickets</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_tickets %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in recent_tickets %}
                                <tr>
                                    <td>#{{ ticket.id }}</td>
                                    <td>{{ ticket.student.full_name if ticket.student else 'N/A' }}</td>
                                    <td>{{ ticket.title[:30] }}{% if ticket.title|length > 30 %}...{% endif %}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if ticket.status == 'open' else 'warning' if ticket.status == 'in_progress' else 'success' }}">
                                            {{ ticket.status|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No recent tickets</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-graduate"></i> Recent Enrollments</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_enrollments %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Course</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in recent_enrollments %}
                                <tr>
                                    <td>{{ enrollment.student.full_name if enrollment.student else 'N/A' }}</td>
                                    <td>{{ enrollment.course.title[:30] if enrollment.course else 'N/A' }}{% if enrollment.course and enrollment.course.title|length > 30 %}...{% endif %}</td>
                                    <td>{{ enrollment.enrollment_date.strftime('%Y-%m-%d') if enrollment.enrollment_date else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No recent enrollments</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% elif session.role == 'faculty' %}
        <!-- Faculty: My Courses -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-book"></i> My Courses</h5>
                    <a href="{{ url_for('faculty.add_course') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Add Course
                    </a>
                </div>
                <div class="card-body">
                    {% if my_courses %}
                    <div class="row">
                        {% for course in my_courses %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">{{ course.title }}</h6>
                                    <p class="card-text text-muted small">{{ course.description[:80] }}{% if course.description|length > 80 %}...{% endif %}</p>
                                    <p class="mb-1"><i class="fas fa-video"></i> {{ course.videos|list|length }} videos</p>
                                    <p class="mb-2"><i class="fas fa-users"></i> {{ course.enrollments|list|length }} students</p>
                                    <a href="{{ url_for('faculty.course_detail', course_id=course.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <p class="text-muted">You haven't created any courses yet.</p>
                        <a href="{{ url_for('faculty.add_course') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Your First Course
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% else %}
        <!-- Student: Enrolled Courses -->
        <div class="col-12">
            <h3 class="mb-3">My Enrolled Courses</h3>
            {% if enrollments %}
            <div class="row">
                {% for enrollment in enrollments %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ enrollment.course.title }}</h5>
                            <p class="card-text text-muted">{{ enrollment.course.description[:100] }}{% if enrollment.course.description|length > 100 %}...{% endif %}</p>
                            <div class="progress mb-3" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ enrollment.progress }}%"></div>
                            </div>
                            <small class="text-muted">Progress: {{ enrollment.progress }}%</small>
                            <div class="mt-3">
                                <a href="{{ url_for('student.course_detail', course_id=enrollment.course.id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-play"></i> Continue Learning
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h5>No Enrolled Courses</h5>
                <p>You haven't enrolled in any courses yet.</p>
                <a href="{{ url_for('student.courses') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Browse Courses
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions for Management/Student -->
    {% if session.role == 'management' %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> Management Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('management.reports') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('management.students') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-users"></i> Students
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('management.courses') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-book"></i> Courses
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('management.support') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-ticket-alt"></i> Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
